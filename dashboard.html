<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facetagram || Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Bubblegum+Sans&family=Great+Vibes&family=Kavoon&family=Lavishly+Yours&family=Luckiest+Guy&family=Montez&family=Niconne&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Dashboard Specific Styles -->
    <style>
        /* Dashboard Specific Styles */
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dashboard-title {
            font-family: 'Alfa Slab One', cursive;
            font-size: 36px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            font-size: 18px;
            color: #666;
            font-weight: 500;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .stat-card.users::before {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .stat-card.posts::before {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .stat-card.reports::before {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .stat-card.active::before {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.users {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .stat-icon.posts {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .stat-icon.reports {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .stat-icon.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .stat-change.negative {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .card-action {
            color: #4CAF50;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .card-action:hover {
            color: #45a049;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .recent-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .recent-item:hover {
            background: rgba(76, 175, 80, 0.05);
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .recent-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recent-info {
            flex: 1;
        }

        .recent-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .recent-action {
            font-size: 12px;
            color: #666;
        }

        .recent-time {
            font-size: 12px;
            color: #999;
            flex-shrink: 0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            text-decoration: none;
            color: inherit;
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }

        .action-icon.users {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .action-icon.gallery {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .action-icon.reports {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .action-description {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .activity-feed {
            grid-column: span 2;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .activity-icon.signup {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .activity-icon.post {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .activity-icon.report {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            color: #333;
            margin-bottom: 5px;
        }

        .activity-time {
            font-size: 12px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Add this before your other scripts -->
    <script type="module">
        import { auth } from './js/firebase-config.js';
        
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.replace('index.html');
            }
        });

        // Prevent back/forward navigation when logged out
        window.addEventListener('popstate', () => {
            if (!auth.currentUser) {
                window.location.replace('index.html');
            }
        });
    </script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-text">Facetagram</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a href="dashboard.html" class="nav-link" data-tooltip="Dashboard">
                            <i class="fas fa-th-large"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="user-management/index.html" class="nav-link" data-tooltip="User Management">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">User Management</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="post-gallery/index.html" class="nav-link" data-tooltip="Gallery">
                            <i class="fas fa-images"></i>
                            <span class="nav-text">Gallery Management</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="post-reports/index.html" class="nav-link" data-tooltip="Report Management">
                            <i class="fas fa-file-alt"></i>
                            <span class="nav-text">Report Management</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <div class="admin-profile" id="adminProfile">
                    <div class="admin-avatar">
                        <img src="images/default-avatar.png" alt="Admin" id="adminAvatar"
                            onerror="this.src='images/default-avatar.png'">
                    </div>
                    <div class="admin-info">
                        <div class="admin-role">Admin</div>
                        <div class="admin-name" id="adminName">Loading...</div>
                    </div>
                </div>
                <div class="admin-dropdown" id="adminDropdown">
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                    <a href="index.html" class="dropdown-item logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title">
                    <h1>Welcome Back!</h1>
                    <h2>Dashboard</h2>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Loading dashboard data...</p>
                </div>

                <!-- Dashboard Content -->
                <div class="dashboard-content" id="dashboardContent" style="display: none;">
                    <!-- Key Metrics -->
                    <div class="stats-overview">
                        <div class="stat-card users">
                            <div class="stat-header">
                                <div class="stat-icon users">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                            <div class="stat-change positive" id="usersChange">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0% from last week</span>
                            </div>
                        </div>

                        <div class="stat-card active">
                            <div class="stat-header">
                                <div class="stat-icon active">
                                    <i class="fas fa-user-check"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Active Users</div>
                            <div class="stat-change positive" id="activeChange">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0% from last week</span>
                            </div>
                        </div>

                        <div class="stat-card posts">
                            <div class="stat-header">
                                <div class="stat-icon posts">
                                    <i class="fas fa-images"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="totalPosts">0</div>
                            <div class="stat-label">Total Posts</div>
                            <div class="stat-change positive" id="postsChange">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0% from last week</span>
                            </div>
                        </div>

                        <!-- <div class="stat-card reports">
                            <div class="stat-header">
                                <div class="stat-icon reports">
                                    <i class="fas fa-flag"></i>
                                </div>
                            </div>
                            <div class="stat-number" id="totalReports">0</div>
                            <div class="stat-label">Pending Reports</div>
                            <div class="stat-change negative" id="reportsChange">
                                <i class="fas fa-arrow-down"></i>
                                <span>-0% from last week</span>
                            </div>
                        </div> -->
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="user-management/index.html" class="action-card">
                            <div class="action-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="action-title">User Management</div>
                            <div class="action-description">Manage user accounts, view profiles, and handle user-related tasks</div>
                        </a>

                        <a href="post-gallery/index.html" class="action-card">
                            <div class="action-icon gallery">
                                <i class="fas fa-images"></i>
                            </div>
                            <div class="action-title">Gallery Management</div>
                            <div class="action-description">Browse and manage all posts, photos, and media content</div>
                        </a>

                        <a href="post-reports/index.html" class="action-card">
                            <div class="action-icon reports">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="action-title">Report Management</div>
                            <div class="action-description">Review and handle reported content and user complaints</div>
                        </a>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
                        <!-- Charts Section -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">Platform Activity</h3>
                                <select id="chartPeriod" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 3 months</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>

                        <!-- Recent Signups -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Signups</h3>
                                <a href="user-management/index.html" class="card-action">View All</a>
                            </div>
                            <div class="recent-list" id="recentSignups">
                                <div class="empty-state">
                                    <i class="fas fa-user-plus"></i>
                                    <p>Loading recent signups...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Feed -->
                    <div class="dashboard-card activity-feed">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                            <a href="#" class="card-action">View All</a>
                        </div>
                        <div class="recent-list" id="activityFeed">
                            <div class="empty-state">
                                <i class="fas fa-clock"></i>
                                <p>Loading recent activities...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div class="error-message" id="errorMessage" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error Loading Data</h3>
                    <p>Unable to connect to Firebase. Please check your configuration.</p>
                    <button class="retry-btn" id="retryBtn">Retry</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script type="module" src="./js/firebase-config.js"></script>
    <script type="module" src="./js/script.js"></script>

    <!-- Dashboard JavaScript -->
    <script type="module">
        import { 
            collection,
            query,
            orderBy,
            limit,
            where,
            getDocs,
            getDoc,
            doc,
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        import { db, auth } from './js/firebase-config.js';

        class DashboardManager {
            constructor() {
                this.activityChart = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadDashboardData();
            }

            setupEventListeners() {
                document.getElementById('retryBtn')?.addEventListener('click', () => this.loadDashboardData());
                document.getElementById('chartPeriod')?.addEventListener('change', () => this.updateChart());
            }

            async loadDashboardData() {
                try {
                    this.showLoading();
                    this.hideError();

                    // Load all data in parallel
                    await Promise.all([
                        this.loadUserStats(),
                        this.loadPostStats(),
                        // this.loadReportStats(),
                        this.loadRecentSignups(),
                        this.loadRecentActivity(),
                        this.initializeChart()
                    ]);

                    this.showDashboard();
                    this.hideLoading();

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showError();
                    this.hideLoading();
                }
            }

            async loadUserStats() {
                try {
                    const usersRef = collection(db, 'Users');
                    const usersSnapshot = await getDocs(usersRef);
                    
                    const totalUsers = usersSnapshot.size;
                    let activeUsers = 0;
                    let newUsersThisWeek = 0;

                    console.log('user snapshots: ' + usersSnapshot);
                    
                    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        
                        console.log('user data: ' + userData.Online);
                        // Check active status using Online boolean (uppercase 'O')
                        if (userData.Online === true) {
                            activeUsers++;
                        }

                        // Count new users this week
                        const createdAt = userData.createdAt?.toDate();
                        if (createdAt && createdAt > oneWeekAgo) {
                            newUsersThisWeek++;
                        }
                    });

                    // Calculate weekly growth percentage
                    const weeklyGrowthRate = totalUsers > 0 ? 
                        ((newUsersThisWeek / totalUsers) * 100).toFixed(1) : 0;

                    // Update UI
                    document.getElementById('totalUsers').textContent = totalUsers;
                    document.getElementById('activeUsers').textContent = activeUsers;
                    
                    // Update growth indicators
                    this.updateStatChange('usersChange', weeklyGrowthRate, true);
                    this.updateStatChange('activeChange', 
                        ((activeUsers / totalUsers) * 100).toFixed(1), 
                        true);

                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            async loadPostStats() {
                try {
                    let totalPosts = 0;
                    
                    const usersRef = collection(db, 'Users');
                    const usersSnapshot = await getDocs(usersRef);

                    for (const userDoc of usersSnapshot.docs) {
                        const postsRef = collection(db, 'Users', userDoc.id, 'PostImages');
                        const postsSnapshot = await getDocs(postsRef);
                        totalPosts += postsSnapshot.size;
                    }

                    document.getElementById('totalPosts').textContent = totalPosts;
                    this.updateStatChange('postsChange', 15, true);

                } catch (error) {
                    console.error('Error loading post stats:', error);
                }
            }

            // async loadReportStats() {
            //     try {
            //         const reportsRef = collection(db, 'Reports');
            //         const pendingQuery = query(reportsRef, where('status', '==', 'pending'));
            //         const pendingSnapshot = await getDocs(pendingQuery);

            //         document.getElementById('totalReports').textContent = pendingSnapshot.size;
            //         this.updateStatChange('reportsChange', 5, false);

            //     } catch (error) {
            //         console.error('Error loading report stats:', error);
            //     }
            // }

            async loadRecentSignups() {
                try {
                    const usersRef = collection(db, 'Users');
                    const recentQuery = query(usersRef, orderBy('createdAt', 'desc'), limit(5));
                    const recentSnapshot = await getDocs(recentQuery);

                    const signupsContainer = document.getElementById('recentSignups');
                    
                    if (recentSnapshot.empty) {
                        signupsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-user-plus"></i>
                                <p>No recent signups</p>
                            </div>
                        `;
                        return;
                    }

                    signupsContainer.innerHTML = '';
                    
                    recentSnapshot.forEach(doc => {
                        const userData = doc.data();
                        const signupDate = userData.createdAt?.toDate() || new Date();
                        
                        const item = document.createElement('div');
                        item.className = 'recent-item';
                        item.innerHTML = `
                            <div class="recent-avatar">
                                <img src="${userData.ProfileImage || 'images/default-avatar.png'}" 
                                     alt="${userData.Username}" 
                                     onerror="this.src='images/default-avatar.png'">
                            </div>
                            <div class="recent-info">
                                <div class="recent-name">${userData.Username || 'Unknown User'}</div>
                                <div class="recent-action">New user signup</div>
                            </div>
                            <div class="recent-time">${this.formatTimeAgo(signupDate)}</div>
                        `;
                        signupsContainer.appendChild(item);
                    });

                } catch (error) {
                    console.error('Error loading recent signups:', error);
                }
            }

            async loadRecentActivity() {
                try {
                    const activities = [];

                    // Get recent posts
                    const usersRef = collection(db, 'Users');
                    const usersSnapshot = await getDocs(usersRef);

                    for (const userDoc of usersSnapshot.docs) {
                        const postsRef = collection(db, 'Users', userDoc.id, 'PostImages');
                        const recentPostsQuery = query(postsRef, orderBy('Timestamp', 'desc'), limit(3));
                        const postsSnapshot = await getDocs(recentPostsQuery);

                        const userData = userDoc.data();

                        postsSnapshot.forEach(postDoc => {
                            const postData = postDoc.data();
                            activities.push({
                                type: 'post',
                                user: userData.Username || 'Unknown User',
                                avatar: userData.ProfileImage || 'images/default-avatar.png',
                                action: 'posted a new photo',
                                time: postData.Timestamp?.toDate() || new Date()
                            });
                        });
                    }

                    // Get recent reports
                    const reportsRef = collection(db, 'Reports');
                    const recentReportsQuery = query(reportsRef, orderBy('Timestamp', 'desc'), limit(3));
                    const reportsSnapshot = await getDocs(recentReportsQuery);

                    for (const reportDoc of reportsSnapshot.docs) {
                        const reportData = reportDoc.data();
                        
                        if (reportData.ReportedBy) {
                            const reporterRef = doc(db, 'Users', reportData.ReportedBy);
                            const reporterSnap = await getDoc(reporterRef);
                            
                            if (reporterSnap.exists()) {
                                const reporterData = reporterSnap.data();
                                activities.push({
                                    type: 'report',
                                    user: reporterData.Username || 'Unknown User',
                                    avatar: reporterData.ProfileImage || 'images/default-avatar.png',
                                    action: `reported content for ${reportData.Reason}`,
                                    time: reportData.Timestamp?.toDate() || new Date()
                                });
                            }
                        }
                    }

                    // Sort by time and limit to 10
                    activities.sort((a, b) => b.time - a.time);
                    activities.splice(10);

                    this.renderActivityFeed(activities);

                } catch (error) {
                    console.error('Error loading recent activity:', error);
                }
            }

            renderActivityFeed(activities) {
                const feedContainer = document.getElementById('activityFeed');
                
                if (activities.length === 0) {
                    feedContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }

                feedContainer.innerHTML = '';
                
                activities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    
                    const iconClass = activity.type === 'post' ? 'post' : 
                                     activity.type === 'report' ? 'report' : 'signup';
                    const icon = activity.type === 'post' ? 'fas fa-camera' : 
                                activity.type === 'report' ? 'fas fa-flag' : 'fas fa-user-plus';
                    
                    item.innerHTML = `
                        <div class="activity-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${activity.user}</strong> ${activity.action}
                            </div>
                            <div class="activity-time">${this.formatTimeAgo(activity.time)}</div>
                        </div>
                    `;
                    feedContainer.appendChild(item);
                });
            }

            async initializeChart() {
                const ctx = document.getElementById('activityChart');
                if (!ctx) return;

                try {
                    // Prepare data structures for daily post counts
                    const dailyPostCounts = new Map();
                    const labels = [];
                    const postData = [];

                    // Get last 7 days dates
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        date.setHours(0, 0, 0, 0);
                        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                        dailyPostCounts.set(date.toDateString(), 0);
                    }

                    // Get all users
                    const usersRef = collection(db, 'Users');
                    const usersSnapshot = await getDocs(usersRef);

                    // Count posts per day
                    for (const userDoc of usersSnapshot.docs) {
                        const postsRef = collection(db, 'Users', userDoc.id, 'PostImages');
                        const postsSnapshot = await getDocs(postsRef);

                        postsSnapshot.forEach(postDoc => {
                            const postData = postDoc.data();
                            const postDate = postData.Timestamp?.toDate();
                            
                            if (postDate) {
                                postDate.setHours(0, 0, 0, 0);
                                const dateString = postDate.toDateString();
                                
                                if (dailyPostCounts.has(dateString)) {
                                    dailyPostCounts.set(dateString, dailyPostCounts.get(dateString) + 1);
                                }
                            }
                        });
                    }

                    // Convert map to array in correct order
                    labels.forEach(label => {
                        const date = new Date();
                        const dayIndex = labels.indexOf(label);
                        date.setDate(date.getDate() - (6 - dayIndex));
                        date.setHours(0, 0, 0, 0);
                        postData.push(dailyPostCounts.get(date.toDateString()) || 0);
                    });

                    // Create or update chart
                    this.activityChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Posts',
                                data: postData,
                                borderColor: '#ff9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'Daily Post Activity',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Posts'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Day of Week'
                                    }
                                }
                            }
                        }
                });

                } catch (error) {
                    console.error('Error creating activity chart:', error);
                }
            }

            updateChart() {
                // In a real implementation, you'd update the chart based on the selected period
                console.log('Chart period changed');
            }

            updateStatChange(elementId, percentage, isPositive) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const icon = isPositive ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                const className = isPositive ? 'positive' : 'negative';
                const sign = isPositive ? '+' : '-';

                element.className = `stat-change ${className}`;
                element.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${sign}${percentage}% from last week</span>
                `;
            }

            formatTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);

                if (diffInSeconds < 60) return 'Just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
                
                return date.toLocaleDateString();
            }

            showLoading() {
                document.getElementById('loadingSpinner').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            showDashboard() {
                document.getElementById('dashboardContent').style.display = 'block';
            }

            showError() {
                document.getElementById('errorMessage').style.display = 'block';
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
    </script>
</body>

</html>